<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link Credit Card - Swift AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="styles/new-style.css">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
        <div class="container-fluid px-4">
            <a class="navbar-brand d-flex align-items-center" href="customer-portal.html">
                <i class="fas fa-arrow-left text-primary me-2"></i>
                <span class="fw-bold">Back to Portal</span>
            </a>
        </div>
    </nav>

    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card border-0 shadow-lg">
                    <div class="card-body p-5">
                        <div class="text-center mb-4">
                            <i class="fas fa-credit-card text-primary fs-1 mb-3"></i>
                            <h3 class="fw-bold">Link Your Credit Card</h3>
                            <p class="text-muted">Add a payment method to start making transactions</p>
                        </div>

                        <form id="cardForm">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Card Number *</label>
                                <input type="text" class="form-control form-control-lg" id="cardNumber"
                                    placeholder="1234 5678 9012 3456" maxlength="19" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">Card Holder Name *</label>
                                <input type="text" class="form-control form-control-lg" id="cardHolder"
                                    placeholder="JOHN DOE" required>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Expiry Month *</label>
                                    <select class="form-select form-select-lg" id="expiryMonth" required>
                                        <option value="">MM</option>
                                        <option value="01">01</option>
                                        <option value="02">02</option>
                                        <option value="03">03</option>
                                        <option value="04">04</option>
                                        <option value="05">05</option>
                                        <option value="06">06</option>
                                        <option value="07">07</option>
                                        <option value="08">08</option>
                                        <option value="09">09</option>
                                        <option value="10">10</option>
                                        <option value="11">11</option>
                                        <option value="12">12</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Expiry Year *</label>
                                    <select class="form-select form-select-lg" id="expiryYear" required>
                                        <option value="">YYYY</option>
                                        <option value="2024">2024</option>
                                        <option value="2025">2025</option>
                                        <option value="2026">2026</option>
                                        <option value="2027">2027</option>
                                        <option value="2028">2028</option>
                                        <option value="2029">2029</option>
                                        <option value="2030">2030</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">CVV *</label>
                                    <input type="text" class="form-control form-control-lg" id="cvv" placeholder="123"
                                        maxlength="4" required>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">Card Type *</label>
                                <select class="form-select form-select-lg" id="cardType" required>
                                    <option value="Visa">Visa</option>
                                    <option value="Mastercard">Mastercard</option>
                                    <option value="American Express">American Express</option>
                                    <option value="Discover">Discover</option>
                                </select>
                            </div>

                            <div class="mb-4">
                                <label class="form-label fw-bold">Billing Address</label>
                                <textarea class="form-control" id="billingAddress" rows="2"
                                    placeholder="123 Main St, City, State, ZIP"></textarea>
                            </div>

                            <div class="alert alert-info border-0 mb-4">
                                <i class="fas fa-shield-alt me-2"></i>
                                <small>Your card information is encrypted and secure</small>
                            </div>

                            <button type="submit" class="btn btn-primary btn-lg w-100">
                                <i class="fas fa-link me-2"></i>Link Card
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        if (!user.email) {
            window.location.href = 'login.html';
        }

        // Format card number as user types
        document.getElementById('cardNumber').addEventListener('input', function (e) {
            let value = e.target.value.replace(/\s/g, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            e.target.value = formattedValue;
        });

        document.getElementById('cardForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const btn = this.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Linking...';
            btn.disabled = true;

            const cardData = {
                email: user.email,
                card_number: document.getElementById('cardNumber').value.replace(/\s/g, ''),
                card_holder: document.getElementById('cardHolder').value,
                expiry_month: document.getElementById('expiryMonth').value,
                expiry_year: document.getElementById('expiryYear').value,
                cvv: document.getElementById('cvv').value,
                card_type: document.getElementById('cardType').value,
                billing_address: document.getElementById('billingAddress').value
            };

            try {
                const response = await fetch('/api/cards/link', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(cardData)
                });

                const result = await response.json();

                if (result.success) {
                    alert('✅ Credit card linked successfully!\n\nYou can now make payments.');
                    window.location.href = 'customer-portal.html';
                } else {
                    alert('❌ Failed to link card: ' + result.message);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });
    </script>
</body>

</html>