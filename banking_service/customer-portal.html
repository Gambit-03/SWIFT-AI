<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Portal - Swift AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="styles/new-style.css">
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
        <div class="container-fluid px-4">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <i class="fas fa-user-shield text-primary fs-3 me-2"></i>
                <span class="fw-bold fs-4">My Account</span>
            </a>
            <div class="d-flex align-items-center gap-2">
                <span class="badge bg-success">Verified Customer</span>
                <button class="btn btn-outline-secondary btn-sm rounded-circle" onclick="toggleTheme()"
                    style="width: 38px; height: 38px;">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
                <div class="dropdown">
                    <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <img src="https://ui-avatars.com/api/?name=Customer&background=0d6efd&color=fff"
                            class="rounded-circle me-2" width="28" height="28">
                        <span id="navUserName">Customer</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" onclick="showSection('profile')"><i
                                    class="fas fa-user me-2"></i>My Profile</a></li>
                        <li><a class="dropdown-item" href="#" onclick="showSection('security')"><i
                                    class="fas fa-shield-alt me-2"></i>Security</a></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i
                                    class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid px-4 py-4">
        <!-- Welcome Section -->
        <div class="row mb-4">
            <div class="col">
                <h2 class="fw-bold">Welcome back, <span id="userName">Customer</span>!</h2>
                <p class="text-muted">Manage your account, view transactions, and monitor security</p>
            </div>
            <div class="col-auto">
                <a href="make-payment.html" class="btn btn-primary btn-lg">
                    <i class="fas fa-credit-card me-2"></i>Make Payment
                </a>
            </div>
        </div>

        <!-- Payment Methods Widget -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-0 pt-4 pb-0">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold"><i class="fas fa-wallet me-2"></i>Payment Methods</h5>
                    <button class="btn btn-primary btn-sm" onclick="window.location.href='link-card.html'">
                        <i class="fas fa-plus me-1"></i>Link New Card
                    </button>
                </div>
            </div>
            <div class="card-body p-4">
                <div id="cardsContainer" class="row g-3">
                    <div class="col-12 text-center py-4 text-muted">
                        <i class="fas fa-spinner fa-spin me-2"></i>Loading cards...
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-muted small mb-1">Total Transactions</p>
                                <h3 class="fw-bold mb-0" id="totalTxns">0</h3>
                            </div>
                            <div class="stat-icon bg-primary-subtle">
                                <i class="fas fa-exchange-alt text-primary"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-muted small mb-1">Total Spent</p>
                                <h3 class="fw-bold mb-0" id="totalSpent">$0</h3>
                            </div>
                            <div class="stat-icon bg-success-subtle">
                                <i class="fas fa-dollar-sign text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-muted small mb-1">Account Risk Score</p>
                                <h3 class="fw-bold mb-0 text-success" id="riskScore">Low</h3>
                            </div>
                            <div class="stat-icon bg-success-subtle">
                                <i class="fas fa-shield-alt text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-muted small mb-1">Registered Devices</p>
                                <h3 class="fw-bold mb-0" id="deviceCount">0</h3>
                            </div>
                            <div class="stat-icon bg-info-subtle">
                                <i class="fas fa-mobile-alt text-info"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <ul class="nav nav-pills mb-4">
            <li class="nav-item">
                <a class="nav-link active" href="#" onclick="showSection('transactions')">
                    <i class="fas fa-list me-2"></i>Transactions
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="showSection('profile')">
                    <i class="fas fa-user me-2"></i>Profile
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="showSection('devices')">
                    <i class="fas fa-laptop me-2"></i>Devices
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="showSection('security')">
                    <i class="fas fa-lock me-2"></i>Security
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="showSection('analytics')">
                    <i class="fas fa-chart-line me-2"></i>Analytics
                </a>
            </li>
        </ul>

        <!-- Transactions Section -->
        <div id="transactionsSection" class="content-section">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 pt-4 pb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold">Transaction History</h5>
                        <button class="btn btn-outline-primary btn-sm" onclick="exportTransactions()">
                            <i class="fas fa-download me-2"></i>Export
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Amount</th>
                                    <th>Location</th>
                                    <th>Channel</th>
                                    <th>Date & Time</th>
                                    <th>Risk Level</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTable">
                                <tr>
                                    <td colspan="7" class="text-center text-muted">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Section -->
        <div id="profileSection" class="content-section" style="display:none;">
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <img src="https://ui-avatars.com/api/?name=Customer&size=120&background=0d6efd&color=fff"
                                class="rounded-circle mb-3" width="120" height="120">
                            <h5 class="fw-bold" id="profileName">Customer Name</h5>
                            <p class="text-muted small" id="profileEmail">email@example.com</p>
                            <span class="badge bg-success">Verified Account</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-0 pt-4 pb-3">
                            <h5 class="mb-0 fw-bold">Personal Information</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold">Full Name</label>
                                    <input type="text" class="form-control" id="editName" placeholder="John Doe">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold">Email</label>
                                    <input type="email" class="form-control" id="editEmail" readonly>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold">Phone Number</label>
                                    <input type="tel" class="form-control" id="editPhone" placeholder="+91 98765 43210">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold">Location</label>
                                    <input type="text" class="form-control" id="editLocation"
                                        placeholder="Mumbai, India">
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="updateProfile()">
                                <i class="fas fa-save me-2"></i>Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Devices Section -->
        <div id="devicesSection" class="content-section" style="display:none;">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 pt-4 pb-3">
                    <h5 class="mb-0 fw-bold">Registered Devices</h5>
                </div>
                <div class="card-body">
                    <div id="devicesList">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Your devices are tracked for security. If you see an unknown device, please contact support
                            immediately.
                        </div>
                        <div class="list-group" id="devicesListGroup">
                            <!-- Devices will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security Section -->
        <div id="securitySection" class="content-section" style="display:none;">
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-0 pt-4 pb-3">
                            <h5 class="mb-0 fw-bold">Change Password</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Current Password</label>
                                <input type="password" class="form-control" id="currentPassword">
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-bold">New Password</label>
                                <input type="password" class="form-control" id="newPassword">
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Confirm New Password</label>
                                <input type="password" class="form-control" id="confirmPassword">
                            </div>
                            <button class="btn btn-danger" onclick="changePassword()">
                                <i class="fas fa-key me-2"></i>Update Password
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-0 pt-4 pb-3">
                            <h5 class="mb-0 fw-bold">Security Settings</h5>
                        </div>
                        <div class="card-body">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="twoFactorAuth" checked>
                                <label class="form-check-label" for="twoFactorAuth">
                                    Two-Factor Authentication (OTP)
                                </label>
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="emailAlerts" checked>
                                <label class="form-check-label" for="emailAlerts">
                                    Email Alerts for Transactions
                                </label>
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="loginNotifications" checked>
                                <label class="form-check-label" for="loginNotifications">
                                    Login Notifications
                                </label>
                            </div>
                            <button class="btn btn-primary" onclick="saveSecuritySettings()">
                                <i class="fas fa-save me-2"></i>Save Settings
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Section -->
        <div id="analyticsSection" class="content-section" style="display:none;">
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-0 pt-4 pb-3">
                            <h5 class="mb-0 fw-bold">Spending Pattern</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="spendingChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-0 pt-4 pb-3">
                            <h5 class="mb-0 fw-bold">Transaction Channels</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="channelChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Define user globally at the top
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        if (!user.email) {
            window.location.href = 'login.html';
        }

        // Helpers
        // Helpers
        function logout() {
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        // Load credit cards
        async function loadCards() {

            const container = document.getElementById('cardsContainer');
            try {
                if (!user || !user.email) {
                    throw new Error('User email not found');
                }

                console.log('Fetching cards for:', user.email);
                const response = await fetch(`/api/cards/${user.email}`);

                if (!response.ok) {
                    throw new Error(`Server returned ${response.status} ${response.statusText}`);
                }

                const cards = await response.json();
                console.log('Cards fetched:', cards);

                if (!Array.isArray(cards)) {
                    throw new Error('Invalid response format (expected array)');
                }

                if (cards.length === 0) {
                    container.innerHTML = `
                        <div class="col-12 text-center py-4">
                            <p class="text-muted mb-3">No cards linked yet</p>
                            <a href="link-card.html" class="btn btn-outline-primary btn-sm">Link Your First Card</a>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = cards.map((card, i) => {
                    const limit = card.limit || 5000;
                    const spent = card.current_spent || 0;
                    const available = limit - spent;
                    const progress = Math.min((spent / limit) * 100, 100);

                    return `
                    <div class="col-md-6">
                        <div class="card bg-light border-0">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0 fw-bold">${card.card_type || 'Card'}</h6>
                                    ${(card.is_primary || i === 0) ? '<span class="badge bg-primary">Primary</span>' : ''}
                                </div>
                                <div class="d-flex align-items-center justify-content-between">
                                    <h5 class="mb-0 overflow-hidden" style="letter-spacing: 2px;">
                                        ${card.card_number || '****'}
                                    </h5>
                                    <button class="btn btn-link text-danger p-0" onclick="deleteCard('${card.card_id}')">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                                <div class="small text-muted mt-2">
                                    Expires: ${card.expiry_month || '00'}/${card.expiry_year || '0000'}
                                </div>
                                <div class="mt-3">
                                    <div class="d-flex justify-content-between small mb-1">
                                        <span>Available: <strong>$${available.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</strong></span>
                                        <span class="text-muted">Limit: $${limit.toLocaleString()}</span>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar ${progress > 90 ? 'bg-danger' : 'bg-primary'}" role="progressbar" style="width: ${progress}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `}).join('');

            } catch (e) {
                console.error('Error loading cards:', e);
                container.innerHTML = `
                    <div class="col-12 text-center text-danger py-4">
                        <i class="fas fa-exclamation-triangle mb-2"></i><br>
                        Error loading cards: ${e.message}<br>
                        <small>Please try refreshing the page</small>
                    </div>
                `;
            }
        }

        async function deleteCard(cardId) {
            if (!confirm('Are you sure you want to remove this card?')) return;

            try {
                const response = await fetch(`/api/cards/delete/${cardId}`, { method: 'DELETE' });
                const result = await response.json();

                if (result.success) {
                    loadCards();
                } else {
                    alert('Failed to delete card: ' + result.message);
                }
            } catch (e) {
                console.error(e);
                alert('Error deleting card');
            }
        }

        // Load customer data
        async function loadCustomerData() {
            try {
                const response = await fetch(`/api/customers/${user.email}`);
                const data = await response.json();

                if (data) {
                    document.getElementById('totalTxns').innerText = data.txn_count || 0;
                    document.getElementById('totalSpent').innerText = '$' + (data.total_spent || 0).toFixed(2);
                    document.getElementById('riskScore').innerText = data.risk_score < 30 ? 'Low' : (data.risk_score < 60 ? 'Medium' : 'High');
                    document.getElementById('editPhone').value = data.phone || '';
                    document.getElementById('editLocation').value = data.location || '';
                }
            } catch (e) {
                console.error('Error loading customer data:', e);
            }
        }

        async function loadTransactions() {
            try {
                const response = await fetch(`/api/transactions?customer=${user.email}`);
                const transactions = await response.json();

                const tbody = document.getElementById('transactionsTable');
                tbody.innerHTML = '';

                transactions.forEach(txn => {
                    const row = document.createElement('tr');

                    // Handle different schemas (simulation vs real bank transfer)
                    const txnId = txn.transaction_id || txn.id || 'N/A';
                    const riskScore = txn.fraud_check ? txn.fraud_check.risk_score : (txn.risk_score || 0);
                    const status = txn.fraud_check ? txn.fraud_check.status : (txn.status || 'COMPLETED');
                    const location = txn.location || (txn.fraud_check && txn.fraud_check.location) || 'Online';
                    const channel = txn.channel || 'Web';

                    const statusClass = (status === 'BLOCKED' || status === 'Blocked') ? 'bg-danger' :
                        ((status === 'REVIEW' || status === 'Review') ? 'bg-warning' : 'bg-success');

                    const riskClass = riskScore > 70 ? 'text-danger' : (riskScore > 40 ? 'text-warning' : 'text-success');

                    row.innerHTML = `
                        <td><code>${txnId}</code></td>
                        <td class="fw-bold">$${txn.amount}</td>
                        <td>
                            <i class="fas fa-map-marker-alt me-1"></i>${location}
                            <div class="small text-muted" style="font-size: 0.7em;">IP: ${txn.ip_address || 'N/A'}</div>
                        </td>
                        <td><i class="fas fa-laptop me-1"></i>${channel}</td>
                        <td>${new Date(txn.timestamp).toLocaleString()}</td>
                        <td><span class="${riskClass}">${riskScore}</span></td>
                        <td><span class="badge ${statusClass}">${status}</span></td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (e) {
                console.error('Error loading transactions:', e);
            }
        }

        function showSection(section) {
            document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));

            document.getElementById(section + 'Section').style.display = 'block';
            event.target.closest('.nav-link').classList.add('active');
        }

        function updateProfile() {
            alert('Profile update functionality - Connect to backend');
        }

        function changePassword() {
            alert('Password change functionality - Connect to backend');
        }

        function saveSecuritySettings() {
            alert('Security settings saved!');
        }

        function exportTransactions() {
            alert('Export functionality - Generate CSV/PDF');
        }

        function logout() {
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('themeIcon').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        }

        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
            document.getElementById('themeIcon').className = 'fas fa-sun';
        }

        loadCards();
        loadCustomerData();
        loadTransactions();
        setInterval(loadTransactions, 30000);
    </script>
</body>

</html>